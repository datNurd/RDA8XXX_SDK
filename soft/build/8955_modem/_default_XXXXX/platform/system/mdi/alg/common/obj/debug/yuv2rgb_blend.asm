# 1 "src/yuv2rgb_blend.S"
# 1 "<built-in>"
# 1 "<command-line>"
# 1 "D:/Desktop/watch/RDA8955_W17.44_IDH/soft/target/8955_modem/include/fpconfig.h" 1
# 1 "<command-line>" 2
# 1 "src/yuv2rgb_blend.S"
#void VidRec_yuv2rgb_blend(char* srcbuf,int src_w,int src_h,char* desbuf,char*backbuf,int padding);
#function: convert yuv422 image to RGB565 format and blend with background image,for LCD display

#2009/08/27 added notation by liyongian.

# 1 "D:/Desktop/watch/RDA8955_W17.44_IDH/soft/platform/chip/regs/8955/include/regdef.h" 1
# 7 "src/yuv2rgb_blend.S" 2

 .data
 .half 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
 .half 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
blue_clip:
 .half 0x0000,0x0001,0x0002,0x0003,0x0004,0x0005,0x0006,0x0007,0x0008,0x0009,0x000a,0x000b,0x000c,0x000d,0x000e,0x000f
 .half 0x0010,0x0011,0x0012,0x0013,0x0014,0x0015,0x0016,0x0017,0x0018,0x0019,0x001a,0x001b,0x001c,0x001d,0x001e,0x001f
 .half 0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f,0x001f
 .half 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
 .half 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
green_clip:
 .half 0x0000,0x0020,0x0040,0x0060,0x0080,0x00a0,0x00c0,0x00e0,0x0100,0x0120,0x0140,0x0160,0x0180,0x01a0,0x01c0,0x01e0
 .half 0x0200,0x0220,0x0240,0x0260,0x0280,0x02a0,0x02c0,0x02e0,0x0300,0x0320,0x0340,0x0360,0x0380,0x03a0,0x03c0,0x03e0
 .half 0x0400,0x0420,0x0440,0x0460,0x0480,0x04a0,0x04c0,0x04e0,0x0500,0x0520,0x0540,0x0560,0x0580,0x05a0,0x05c0,0x05e0
 .half 0x0600,0x0620,0x0640,0x0660,0x0680,0x06a0,0x06c0,0x06e0,0x0700,0x0720,0x0740,0x0760,0x0780,0x07a0,0x07c0,0x07e0
 .half 0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0
 .half 0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0,0x07e0
 .half 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
red_clip:
 .half 0x0000,0x0800,0x1000,0x1800,0x2000,0x2800,0x3000,0x3800,0x4000,0x4800,0x5000,0x5800,0x6000,0x6800,0x7000,0x7800
 .half 0x8000,0x8800,0x9000,0x9800,0xa000,0xa800,0xb000,0xb800,0xc000,0xc800,0xd000,0xd800,0xe000,0xe800,0xf000,0xf800
 .half 0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800,0xf800

 .text
 .globl VidRec_yuv2rgb_blend
 .ent VidRec_yuv2rgb_blend
 .set noreorder

 #VidRec_yuv2rgb_blend(char* srcbuf,int src_w,int src_h,char* desbuf,char*backbuf,int padding)

VidRec_yuv2rgb_blend:
 subu $29, $29, 64
 sw $31, 60($29)
 sw $30, 56($29)
 sw $16, 52($29)
 sw $17, 48($29)
 sw $18, 44($29)
 sw $19, 40($29)
 sw $20, 36($29)
 sw $21, 32($29)
 sw $22, 28($29)
 sw $23, 24($29)
 li $16, 454
 li $17, 88
 li $18, 183
 li $19, 359
 la $20, blue_clip
 la $21, green_clip
 la $22, red_clip
 li $8, 0xdfffffff
 sw $5, 68($29)
 lw $23, 80($29)
 lw $3, 84($29)
 and $4, $4, $8
 and $23, $23, $8
 cache 2, 0
 nop
 nop
 nop

loop_height:
loop_width:
 lbu $8, 0($4)
 lbu $9, 1($4)
 lbu $11, 3($4)
 addiu $9, $9, -128
 addiu $11, $11, -128

 mult $9, $16
 lbu $10, 2($4) #remove nop
 mflo $12

 mult $9, $17
 sra $12, $12, 0x8 #$12 = U*454>>8
 madd $11, $18
 addu $15, $8, $12
 mflo $13
 sra $13, $13, 0x8 #$12 = (U*88+V*183)>>8

 mult $11, $19
 subu $24, $8, $13
 lh $2, 0($23)
 mflo $14

 bnez $2, back_not_trans1
 sra $14, $14, 0x8 #$14 = V*359>>8

 addiu $15, $15, 0x4 #B
 sra $15, $15, 0x3
 sll $15, $15, 0x1
 addu $15, $15, $20
 lh $15, 0($15)

 addiu $24, $24, 0x2 #G
 sra $24, $24, 0x2
 sll $24, $24, 0x1
 addu $24, $24, $21
 lh $24, 0($24)

 addu $25, $8, $14
 addiu $25, $25, 0x4 #R
 sra $25, $25, 0x3
 sll $25, $25, 0x1
 addu $25, $25, $22
 lh $25, 0($25)

 or $2, $15, $24
 or $2, $2, $25

back_not_trans1:
 sh $2, 0($7)

 addu $15, $10, $12

 lh $2, 2($23)

 sra $15, $15, 0x3

 bnez $2, back_not_trans2
 addiu $23, $23, 0x4

 sll $15, $15, 0x1
 addu $15, $15, $20
 lh $15, 0($15)

 subu $24, $10, $13
 sra $24, $24, 0x2
 sll $24, $24, 0x1
 addu $24, $24, $21
 lh $24, 0($24)

 addu $25, $10, $14
 sra $25, $25, 0x3
 sll $25, $25, 0x1
 addu $25, $25, $22
 lh $25, 0($25)

 or $2, $15, $24
 or $2, $2, $25

back_not_trans2:
 sh $2, 2($7)

 addiu $4, $4, 0x4
 addiu $5, $5, -2
 bne $5, $0, loop_width
 addiu $7, $7, 0x4
 addu $7, $7, $3
 addu $23, $23, $3
 addiu $6, $6, -1
 bne $6, $0, loop_height
 lw $5, 68($29)

 lw $31, 60($29)
 lw $30, 56($29)
 lw $16, 52($29)
 lw $17, 48($29)
 lw $18, 44($29)
 lw $19, 40($29)
 lw $20, 36($29)
 lw $21, 32($29)
 lw $22, 28($29)
 lw $23, 24($29)
 jr $31
 addu $29, $29, 64
 .set reorder
 .end VidRec_yuv2rgb_blend
